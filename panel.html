<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Control Panel</title>
    <style>
        :root { color-scheme: dark; }
        html,body { margin:0; font-family:system-ui, sans-serif; background:#0f1115; color:#e6e6e6; }
        header { padding:16px 20px; border-bottom:1px solid #202632; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
        main { padding:16px 20px; display:grid; grid-template-columns: repeat(auto-fit, minmax(360px, 1fr)); gap:16px; }
        .card { background:#131824; border:1px solid #202632; border-radius:14px; padding:14px; }
        .row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        label { font-size:12px; color:#aab; }
        input, select { background:#0e1320; color:#e6e6e6; border:1px solid #2a3242; border-radius:8px; padding:8px 10px; }
        button { background:#2b6fef; color:white; border:0; border-radius:8px; padding:8px 12px; cursor:pointer; }
        button.secondary { background:#384255; }
        h3 { margin:0 0 10px 0; font-size:16px; color:#dfe6ff; }
        .list { display:flex; flex-direction:column; gap:8px; }
        .item { display:flex; justify-content:space-between; align-items:center; background:#0f1422; border:1px solid #242c3d; border-radius:10px; padding:10px; }
        small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; color:#9ab; }
        .btns { display:flex; gap:8px; }
    </style>
</head>
<body>
<header>
    <strong>Control Panel</strong>
    <a href="/overlay" target="_blank"><button class="secondary">Open Overlay</button></a>
    <button id="refreshClients" class="secondary">Clients: <span id="clients">0</span></button>
    <button id="reload" class="secondary">Reload Catalog</button>
    <button id="saveState" class="secondary">Save State</button>
    <button id="syncOverlay" class="secondary">Sync Overlay</button>
</header>

<main>
    <section class="card">
        <h3>Donation Toast</h3>
        <div class="row">
            <div><label>Donor</label><br/><input id="donor" value="Viewer"/></div>
            <div><label>Amount (USD)</label><br/><input id="amount" type="number" value="5.99" step="0.01" min="0"/></div>
        </div>
        <div class="row" style="margin-top:8px;">
            <div style="flex:1;"><label>Message</label><br/><input id="msg" style="width:100%;" placeholder="Say hi!"/></div>
            <button id="sendDonation">Send</button>
        </div>
    </section>

    <section class="card">
        <h3>Text-to-Speech (Direct)</h3>
        <div class="row">
            <div style="flex:1;"><label>Text</label><br/><input id="ttsText" style="width:100%;" placeholder="Hello, world"/></div>
        </div>
        <div class="row" style="margin-top:8px;">
            <div><label>Voice hint (optional)</label><br/><input id="ttsVoice" placeholder="Google / UK / Zira"/></div>
            <button id="sendTTS">Speak Now</button>
        </div>
        <small class="mono">Overlay must be open; click “Enable Sound” there once.</small>
    </section>

    <section class="card">
        <h3>TTS Queue (Moderation)</h3>
        <div class="row">
            <div style="flex:1;"><label>Submit to queue (simulate viewer)</label><br/><input id="qText" style="width:100%;" placeholder="Viewer TTS text"/></div>
        </div>
        <div class="row" style="margin-top:8px;">
            <div><label>Voice hint</label><br/><input id="qVoice" placeholder="Google / UK / Zira"/></div>
            <div><label>Donor (optional)</label><br/><input id="qDonor" placeholder="Viewer"/></div>
            <div><label>Amount (USD)</label><br/><input id="qAmount" type="number" value="0" step="0.01" min="0"/></div>
            <button id="qSubmit">Submit</button>
        </div>
        <div style="margin-top:10px;">
            <div class="row" style="justify-content:space-between;">
                <h4 style="margin:0;">Pending Items</h4>
                <button id="qRefresh" class="secondary">Refresh</button>
            </div>
            <div id="qList" class="list"><div class="item"><em>None pending</em></div></div>
        </div>
    </section>

    <section class="card">
        <h3>Requests (Board + Phone)</h3>
        <div class="row">
            <div><label>Board (optional)</label><br/><input id="rqBoard" placeholder="e.g., X soundboard"/></div>
            <div><label>Phone (optional)</label><br/><input id="rqPhone" placeholder="e.g., (555) 123-4567"/></div>
        </div>
        <div class="row" style="margin-top:8px;">
            <div style="flex:1;"><label>Note (optional)</label><br/><input id="rqNote" style="width:100%;" placeholder="Context for the call"/></div>
            <button id="rqSubmit">Submit</button>
        </div>

        <div style="margin-top:10px;">
            <div class="row" style="justify-content:space-between;">
                <h4 style="margin:0;">Pending Requests</h4>
                <button id="rqRefresh" class="secondary">Refresh</button>
            </div>
            <div id="rqList" class="list"><div class="item"><em>None pending</em></div></div>
        </div>

        <div style="margin-top:10px;">
            <h4 style="margin:0 0 8px 0;">Active Requests</h4>
            <div id="rqActive" class="list"><div class="item"><em>None</em></div></div>
        </div>
    </section>

    <section class="card">
        <h3>Abilities</h3>
        <div id="abilities" class="list"><div class="item"><em>Loading…</em></div></div>
    </section>

    <section class="card">
        <h3>Quests (Catalog)</h3>
        <div id="quests" class="list"><div class="item"><em>Loading…</em></div></div>
    </section>

    <section class="card">
        <h3>Active Quests</h3>
        <div id="active" class="list"><div class="item"><em>None yet</em></div></div>
    </section>
</main>

<script>
    const elClients = document.getElementById('clients');
    async function refreshClients() {
        const t = await fetch('/api/debug/clients').then(r => r.text()).catch(()=> 'clients: 0');
        elClients.textContent = (t.match(/\d+/) || ['0'])[0];
    }
    document.getElementById('refreshClients').onclick = refreshClients;
    document.getElementById('reload').onclick = async () => { await fetch('/api/catalog/reload', {method:'POST'}); await loadCatalog(); };
    document.getElementById('saveState').onclick = async () => { await fetch('/api/state/save', {method:'POST'}); };
    document.getElementById('syncOverlay').onclick = async () => { await fetch('/api/state/rehydrate', {method:'POST'}); };
    refreshClients();

    // Donation
    document.getElementById('sendDonation').onclick = async () => {
        const donor = document.getElementById('donor').value || 'Viewer';
        const amountD = parseFloat(document.getElementById('amount').value || '0');
        const cents = Math.max(0, Math.round(amountD * 100));
        const msg = encodeURIComponent(document.getElementById('msg').value || '');
        await fetch(`/api/donation?donor=${encodeURIComponent(donor)}&amount_cents=${cents}&msg=${msg}`);
        refreshClients();
    };

    // TTS direct
    document.getElementById('sendTTS').onclick = async () => {
        const text = encodeURIComponent(document.getElementById('ttsText').value || '');
        if (!text) return;
        const voice = encodeURIComponent(document.getElementById('ttsVoice').value || '');
        await fetch(`/api/test/tts?text=${text}&voice=${voice}`);
        refreshClients();
    };

    // Catalog → Abilities & Quests
    async function loadCatalog() {
        const data = await fetch('/api/catalog').then(r => r.json());
        const abil = document.getElementById('abilities');
        const ques = document.getElementById('quests');
        abil.innerHTML = ''; ques.innerHTML = '';

        data.abilities.forEach(a => {
            const d = document.createElement('div');
            d.className = 'item';
            d.innerHTML = `<div><strong>${a.name}</strong> <small class="mono">($${((a.price_cents||0)/100).toFixed(2)}, cd ${a.cooldown_ms||3000}ms, vol ${a.volume ?? 0.7})</small><br/><small class="mono">${a.id}</small></div>`;
            const b = document.createElement('button');
            b.textContent = 'Fire';
            b.onclick = () => fetch(`/api/ability/fire?id=${encodeURIComponent(a.id)}`);
            d.appendChild(b);
            abil.appendChild(d);
        });

        data.quests.forEach(q => {
            const d = document.createElement('div');
            d.className = 'item';
            const tgt = q.target || 1;
            d.innerHTML = `<div><strong>${q.name}</strong> <small class="mono">($${((q.price_cents||0)/100).toFixed(2)}, target ${tgt})</small><br/><small class="mono">${q.id}</small></div>`;
            const b = document.createElement('button');
            b.textContent = 'Start';
            b.onclick = async () => { await fetch(`/api/quest/add?id=${encodeURIComponent(q.id)}`); loadActiveQuests(); };
            d.appendChild(b);
            ques.appendChild(d);
        });
        loadActiveQuests();
    }

    // Active quests controls
    async function loadActiveQuests() {
        const data = await fetch('/api/quest/active').then(r => r.json());
        const list = document.getElementById('active');
        list.innerHTML = data.length ? '' : '<div class="item"><em>None yet</em></div>';
        data.forEach(qs => {
            const d = document.createElement('div');
            d.className = 'item';
            d.innerHTML = `<div><strong>${qs.name}</strong> <small class="mono"> ${qs.progress}/${qs.target}</small><br/><small class="mono">${qs.id}</small></div>`;
            const btns = document.createElement('div'); btns.className = 'btns';
            const inc = document.createElement('button'); inc.textContent = '+1'; inc.onclick = async () => { await fetch(`/api/quest/inc?id=${encodeURIComponent(qs.id)}`, {method:'POST'}); loadActiveQuests(); };
            const reset = document.createElement('button'); reset.textContent = 'Reset'; reset.className='secondary'; reset.onclick = async () => { await fetch(`/api/quest/reset?id=${encodeURIComponent(qs.id)}`, {method:'POST'}); loadActiveQuests(); };
            const remove = document.createElement('button'); remove.textContent = 'Remove'; remove.className='secondary'; remove.onclick = async () => { await fetch(`/api/quest/remove?id=${encodeURIComponent(qs.id)}`, {method:'POST'}); loadActiveQuests(); };
            btns.append(inc, reset, remove);
            d.appendChild(btns);
            list.appendChild(d);
        });
        refreshClients();
    }

    // TTS moderation queue
    const qList = document.getElementById('qList');
    async function loadQueue() {
        const items = await fetch('/api/tts/queue').then(r => r.json());
        qList.innerHTML = items.length ? '' : '<div class="item"><em>None pending</em></div>';
        items.forEach(it => {
            const d = document.createElement('div');
            d.className = 'item';
            const dollars = (Number(it.amount_cents||0)/100).toFixed(2);
            d.innerHTML = `<div>
          <strong>${it.text}</strong><br/>
          <small class="mono">${it.voice || 'default voice'}</small> |
          <small class="mono">${it.donor || 'Anonymous'}</small> |
          <small class="mono">$${dollars}</small>
        </div>`;
            const btns = document.createElement('div'); btns.className = 'btns';
            const approve = document.createElement('button'); approve.textContent = 'Approve'; approve.onclick = async () => { await fetch(`/api/tts/approve?id=${it.id}`, {method:'POST'}); loadQueue(); };
            const reject = document.createElement('button'); reject.textContent = 'Reject'; reject.className='secondary'; reject.onclick = async () => { await fetch(`/api/tts/reject?id=${it.id}`, {method:'POST'}); loadQueue(); };
            btns.append(approve, reject);
            d.appendChild(btns);
            qList.appendChild(d);
        });
    }
    document.getElementById('qRefresh').onclick = loadQueue;

    document.getElementById('qSubmit').onclick = async () => {
        const text = document.getElementById('qText').value || '';
        if (!text) return;
        const voice = document.getElementById('qVoice').value || '';
        const donor = document.getElementById('qDonor').value || '';
        const amountD = parseFloat(document.getElementById('qAmount').value || '0');
        const cents = Math.max(0, Math.round(amountD * 100));
        const url = `/api/tts/submit?text=${encodeURIComponent(text)}&voice=${encodeURIComponent(voice)}&donor=${encodeURIComponent(donor)}&amount_cents=${cents}`;
        await fetch(url);
        document.getElementById('qText').value = '';
        loadQueue();
        refreshClients();
    };

    // Requests (board + phone)
    const rqList = document.getElementById('rqList');
    const rqActive = document.getElementById('rqActive');

    document.getElementById('rqSubmit').onclick = async () => {
        const board = document.getElementById('rqBoard').value || '';
        const phone = document.getElementById('rqPhone').value || '';
        const note = document.getElementById('rqNote').value || '';
        const url = `/api/request/submit?board=${encodeURIComponent(board)}&phone=${encodeURIComponent(phone)}&note=${encodeURIComponent(note)}`;
        const res = await fetch(url);
        if (res.ok) {
            document.getElementById('rqNote').value = '';
            loadRequestQueue(); loadRequestActive();
        }
    };

    async function loadRequestQueue() {
        const items = await fetch('/api/request/queue').then(r => r.json());
        rqList.innerHTML = items.length ? '' : '<div class="item"><em>None pending</em></div>';
        items.forEach(it => {
            const d = document.createElement('div');
            d.className = 'item';
            d.innerHTML = `<div>
          <strong>${it.board || '(no board)'}${it.note ? ' — ' + it.note : ''}</strong><br/>
          <small class="mono">Phone: ${it.phone ? it.phone : '(none)'}</small> |
          <small class="mono">Masked: ${it.masked_phone || '(none)'}</small>
        </div>`;
            const btns = document.createElement('div'); btns.className = 'btns';
            const approve = document.createElement('button'); approve.textContent = 'Approve'; approve.onclick = async () => { await fetch(`/api/request/approve?id=${it.id}`, {method:'POST'}); loadRequestQueue(); loadRequestActive(); };
            const reject = document.createElement('button'); reject.textContent = 'Reject'; reject.className='secondary'; reject.onclick = async () => { await fetch(`/api/request/reject?id=${it.id}`, {method:'POST'}); loadRequestQueue(); };
            btns.append(approve, reject);
            d.appendChild(btns);
            rqList.appendChild(d);
        });
    }

    async function loadRequestActive() {
        const items = await fetch('/api/request/active').then(r => r.json());
        rqActive.innerHTML = items.length ? '' : '<div class="item"><em>None</em></div>';
        items.forEach(it => {
            const d = document.createElement('div');
            d.className = 'item';
            d.innerHTML = `<div>
          <strong>${it.board || '(no board)'}${it.note ? ' — ' + it.note : ''}</strong><br/>
          <small class="mono">Masked: ${it.masked_phone || '(none)'}</small>
        </div>`;
            const btns = document.createElement('div'); btns.className = 'btns';
            const done = document.createElement('button'); done.textContent = 'Complete'; done.onclick = async () => { await fetch(`/api/request/complete?id=${it.id}`, {method:'POST'}); loadRequestActive(); };
            btns.append(done);
            d.appendChild(btns);
            rqActive.appendChild(d);
        });
    }

    // Init
    loadCatalog();
    loadQueue();
    loadRequestQueue();
    loadRequestActive();
</script>
</body>
</html>
